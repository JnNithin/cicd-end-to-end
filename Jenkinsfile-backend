//import library
@Library('shared-lib@main') _


pipeline {
    agent any



    stages {
        stage('CheckOut') {
            steps {
                git credentialsId: 'bbc69362-59e8-44be-95c6-39f5109027cf',
                url: 'https://github.com/livevil8/cicd-end-to-end',
                branch: 'main'
            }
        }
        stage('Terraform Init') {
            steps {
                script {
                    terraformInit()
                }
            }
        }
        stage('Terraform Validate and Format') {
            steps {
                script {
                    terraformValidateAndFormat()
                }
            }
        }
        stage('Plan') {
            steps {
                script {
                    terraformPlan('backend-planFile.tfplan')
                }
            }
        }
        stage('ApplyOrDestroy') {
            steps {
                script {
                    def terraformAction = params.ACTION
                    try {
                        // Use tfplan file based on the selected action
                        if (terraformAction == 'apply') {
                            sh 'terraform apply backend-planFile.tfplan --auto-approve'
                        } else if (terraformAction == 'destroy') {
                            sh 'terraform destroy backend-planFile.tfplan --auto-approve'
                        }
                    } catch (Exception e) {
                        currentBuild.result = 'FAILURE' // Set the build result to FAILURE on error
                        error "Terraform apply/destroy failed: ${e.message}"
                    }
                }
            }
        }
        stage('Trigger Jenkins-Worker Pipeline') {
            steps {
                script {
                    if (currentBuild.result == 'SUCCESS') {
                        // Only trigger the worker pipeline if the previous stages were successful
                        build job: 'Jenkinsfile-workerNode', propagate: false, wait: false
                    } else {
                        echo "Skipping worker pipeline trigger due to previous failures."
                    }
                }
            }
        }
    }
    post {
        success {
            // Store artifacts with dynamic names
            def buildNumber = currentBuild.getNumber()
            def currentDate = new Date().format('yyyyMMdd-HHmmss')
            def artifactsPath = "artifacts/backend-artifacts/${buildNumber}_${currentDate}"
            
            // Archive artifacts
            archiveArtifacts artifacts: "Artifacts/backend-artifacts/**", fingerprint: true
        }
    }
}